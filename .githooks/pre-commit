#!/bin/sh
#
# Git Hook: pre-commit
# 目的: コミットされるPHPファイルに対し、Laravel Pint を自動実行する
# 実行環境: Laravel Sail (Dockerコンテナ内)

# ----------------------------------------------------
# 1. ステージングされているPHPファイルの一覧を取得
# ----------------------------------------------------
# --cached: ステージングエリア（インデックス）のファイル
# --name-only: ファイル名のみを抽出
# --diff-filter=AMCR: 新規追加(A)、変更(M)、名前変更(C/R)されたファイルが対象
# grep -E '\.(php|blade\.php)$': PHPファイルとBladeファイルのみをフィルタリング
FILES=$(git diff --cached --name-only --diff-filter=AMCR | grep -E '\.(php|blade\.php)$')

# ----------------------------------------------------
# 2. 対象ファイルが存在するか確認
# ----------------------------------------------------
if [ -z "$FILES" ]; then
    echo "コミット対象のPHPファイルが見つかりませんでした。Pint処理をスキップします。"
    exit 0
fi

echo "--- ステージングされているPHPファイルに対して Laravel Pint を実行します (Sail経由) ---"

# ----------------------------------------------------
# 3. Sail経由で Pint を実行
# ----------------------------------------------------
# xargsで安全にファイル名をスペース区切りで渡す
FILENAMES=$(echo "$FILES" | xargs)

# 実行コマンド: SailのPHPサービスコンテナ内で Pint バイナリを起動し、対象ファイルリストを渡す
# 注意: コマンド実行時のカレントディレクトリは常にリポジトリルートです
sail php ./vendor/bin/pint $FILENAMES

# Pintの終了コードを取得
PINT_RESULT=$?

if [ $PINT_RESULT -ne 0 ]; then
    echo "---------------------------------------------------------"
    echo "⚠️ Pint の実行中にエラーが発生した可能性があります。"
    echo "  → Pintによる整形は行われたはずですが、出力を確認してください。"
    echo "---------------------------------------------------------"
    # Pintがエラーで終了しても、このスクリプトは整形後のコードをコミットさせるため、続行します。
fi


# ----------------------------------------------------
# 4. Pintによる修正をステージングし直す (必須)
# ----------------------------------------------------
echo "--- Pintによる修正を自動でステージングに追加します ---"
# Pintがコードを修正した場合、その変更を再度 git add することでコミットに含めます
echo "$FILES" | xargs git add

# ----------------------------------------------------
# 5. スクリプトを終了 (コミット処理続行)
# ----------------------------------------------------
exit 0
